#!/bin/bash

hc() { herbstclient "$@" ; }

get_pid() { # $1 - wid
  xprop -id "$1" _NET_WM_PID | awk '{ print $3 }'
}

is_child() { # $1 - child_pid, $2 - parent_pid
  children="$(pstree -T -p "$2")"
  grep -q "$1" <<< "$children" && echo "y"
}

chomp() {
  # $1 - wid to chomp
  hc set_attr clients."${1}".minimized true
}

blergh() {
  # $1 - wid to blergh
  hc set_attr clients."${1}".minimized false
  # bspc node "$1" --focus
}

last_wid=""

# remember that you made node_remove return pid
hc --idle '(focus_changed|rule)' | \
  while read -r a b c; do
    # {{{ parse
    if [[ "$a" == "rule" && "$b" == "node_add" ]]; then
      hook="$b"
      wid="$c"
    elif [[ "$a" == "focus_changed" ]]; then
      hook="$a"
      wid="$b"
    fi
    # }}}
    echo "$hook $wid"

    if [[ "$hook" == "node_add" ]]; then
      if ! [[ "$last_wid" == "" ]]; then
        if ! [[ "$last_wid" == "$wid" ]]; then
          last_pid=$(get_pid "$last_wid")
          pid=$(get_pid "$wid")
          echo "$pid child of $last_pid?"
          if is_child "$pid" "$last_pid"; then
            chomp "$last_wid"
          fi
        fi
      fi
    fi

    [[ "$hook" == "focus_changed" ]] && last_wid="$wid"
  done
