#!/bin/bash

#: note keeping script featuring tfidf
#& tfidf rofi

# FIXME
# convert to a rofi script

# wants:
# + filenames are <unix-timestamp>.md
# + tfidf autotagging
# + rofi: first line of the note + tfidf
# + a subcommand to open a new note form a terminal
# + a nice way to open a new note from rofi
# + clean up empty files on quit

notes="$HOME/.garden/usr/notes"

new() { # new note
  name="$(date +%s)"
  echo "$notes/$name.md"
}

tags() { # first line of each file and its tags
  echo -e "<!--new-->new\n<i><span foreground='#666666'>open a blank note</span></i>"
  while IFS=: read -r path tags; do
    #date=${path##*/} ; date=${date%%.*} ; $(date -d @$date '+%D, %d')
    echo -e "	<!--$path-->$(head -n 1 "$path")<i><span foreground='#666666'>\n$tags</span></i>"
  done < <({
    awk '
      {
        if (length($2) > 2 && $3 > 0.1 && length(tags[$1]) < 500) tags[$1]=$2" "tags[$1]
      } END {
        for (text in tags) print text":"tags[text]
      }' <(tfidf "$notes")
  } | sort -nr)
}

alacritty-edit() {
  alacritty -e sh -c "$EDITOR $1"
}

case $1 in
  -h|--help) echo "\$ scribe [new]" ;;
  new) "$EDITOR" "$(new)" ;;
  *)
    selection="$(tags | rofi -theme "vertical.rasi" -dmenu -sep '	' -eh 2 -p "scribe" -matching normal -markup-rows -lines 10)"
    if [[ -n $selection ]]; then
      selection=${selection#*'<!--'}
      selection=${selection%'-->'*}
      if [[ $selection == "new" ]]; then
        alacritty-edit "$(new)"
      else
        alacritty-edit "$selection"
      fi
    fi
    ;;
esac

# clean up empty files
for f in "$notes"/*; do
  [ ! -s "$f" ] && rm "$f"
done

# old fzf code
#opt=(
#  --exact
#  --no-hscroll
#  --info=hidden
#  --no-sort
#  --with-nth=2..
#  --tiebreak=begin
#  --tac
#  --bind tab:down
#  --bind shift-tab:up
#  --bind change:first)
#selection="$(tags \
#  | tr -d '\n' \
#  | tr '	' '\n' \
#  | sed 's/<!--//; s/-->/ /;' \
#  | fzf "${opt[@]}" \
#  | awk '{ print $1 }')"
#if [[ -n $selection ]]; then
#  nvim "$selection"
#fi
